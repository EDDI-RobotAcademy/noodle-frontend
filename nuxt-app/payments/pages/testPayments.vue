<template>
    <div class="wrapper">
        <div class="box_section">
            <!-- 결제 UI -->
            <div id="payment-method"></div>
            <!-- 이용약관 UI -->
            <div id="agreement"></div>
            <!-- 쿠폰 체크박스 -->
            <div style="padding-left: 25px">
                <div class="checkable typography--p">
                    <label for="coupon-box" class="checkable__label typography--regular">
                        <input :disabled="!inputEnabled" @change="updateAmount" id="coupon-box" class="checkable__input"
                            type="checkbox" aria-checked="true" /><span class="checkable__label-text">5원 쿠폰
                            적용</span>
                    </label>
                </div>
            </div>
            <!-- 결제하기 버튼 -->
            <v-btn :disabled="!inputEnabled" @click="requestPayment" class="button" id="payment-button"
                style="margin-top: 30px">결제하기</v-btn>
        </div>
    </div>
</template>

<script>
import { loadPaymentWidget, ANONYMOUS } from "@tosspayments/payment-widget-sdk";
import { useRuntimeConfig } from "nuxt/app";
import { nanoid } from "nanoid";
import { defineComponent, onMounted } from "vue";

export default defineComponent({
    setup() {
        const config = useRuntimeConfig();

        const paymentWidget = ref(null)
        const paymentMethodWidget = ref(null)
        const clientKey = ref(config.public.TOSS_CLIENT_KEY)
        const customerKey = ref(null)
        const amount = ref(10)
        const inputEnabled = ref(false)
        const discountCouponAmount = ref(5)

        async function requestPayment() {
            try {
                if (paymentWidget.value) {
                    await paymentWidget.value.requestPayment({
                        orderId: nanoid(),
                        orderName: "크아아악",
                        customerName: "뭐 어쩌라고",
                        customerEmail: "fuck@gmail.com",
                        customerMobilePhone: "01012341234",
                        successUrl: `${window.location.origin}/success`,
                        failUrl: `${window.location.origin}/fail`
                    })
                }
            } catch (error) {
                console.log(error)
            }
        }
        async function updateAmount() {
            const coupon = document.getElementById("coupon-box")
            if (coupon.checked == true) {
                amount.value -= discountCouponAmount.value
                paymentMethodWidget.value.updateAmount(amount.value);
            } else {
                paymentMethodWidget.value.updateAmount(amount.value);
            }
            console.log(amount.value)
        }

        onMounted(async () => {
            paymentWidget.value = await loadPaymentWidget(clientKey.value, ANONYMOUS)
            paymentMethodWidget.value = paymentWidget.value.renderPaymentMethods("#payment-method", { value: amount.value }, { variantKey: "DEFAULT" })
            paymentWidget.value.renderAgreement("#agreement", { variantKey: "AGREEMENT" })
            paymentMethodWidget.value.on("ready", () => {
                inputEnabled.value = true
            })
        })

        return {
            paymentWidget,
            paymentMethodWidget,
            clientKey,
            customerKey,
            amount,
            inputEnabled,

            requestPayment,
            updateAmount,
        }
    }
})
</script>